<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bavaria State – Juristische Staatsprüfung</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const supabaseUrl = "https://nwjfaikejvxqfhmqhsam.supabase.co";
const supabaseKey = "sb_publishable_mPuwRisWHWmQR7hdLx1K1A_WsLvGlqu";
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
</script>

<style>
body{margin:0;font-family:Arial;background:#0b1220;color:white;}
header{text-align:center;padding:20px;}
header img{width:260px;}
.container{max-width:1100px;margin:auto;background:#111827;padding:30px;border-radius:12px;}
.question{background:#0f172a;padding:15px;border-radius:8px;margin:20px 0;}
button{padding:10px 20px;background:#2563eb;color:white;border:none;border-radius:6px;cursor:pointer;}
button:hover{background:#1d4ed8;}
.sticky-timer{
position:fixed;
top:0;
right:0;
background:#111827;
padding:15px 25px;
font-size:18px;
font-weight:bold;
color:#f87171;
border-bottom-left-radius:12px;
z-index:999;
}
.hidden{display:none;}
</style>
</head>

<body>

<div class="sticky-timer">
Zeit: <span id="time">15:00</span>
</div>

<header>
<img src="logo.png">
<h1>Bavaria State – Juristische Staatsprüfung</h1>
</header>

<div class="container">

<label>RP-Name</label>
<input type="text" id="rpname">

<label>Kanzlei</label>
<input type="text" id="kanzlei">

<div id="quiz"></div>

<button id="submitBtn" onclick="submitExam()">Prüfung abgeben</button>

<div id="result" class="hidden"></div>

<hr>

<h3>Admin Login</h3>
<input type="email" id="adminEmail" placeholder="Admin Email">
<input type="password" id="adminPass" placeholder="Admin Passwort">
<button onclick="adminLogin()">Admin Login</button>

</div>

<script>

const TOTAL_QUESTIONS = 20;
const PASS_PERCENTAGE = 80;
const TIME_LIMIT = 15 * 60;

let timeLeft = TIME_LIMIT;
let submitted = false;
let currentQuestions = [];
let timerInterval;

const questionPool = [

{q:"Was schützt §1?",a:["Eigentum","Menschenwürde","Staatsgewalt","Polizei"],c:1},
{q:"Was verbietet §1 ausdrücklich?",a:["Steuern","Erniedrigung","Führerscheinpflicht","Insolvenz"],c:1},
{q:"Was regelt §2?",a:["Gleichheit vor dem Gesetz","Waffenrecht","Insolvenz","Notstand"],c:0},
{q:"Wann darf Eigentum entzogen werden (§4)?",a:["Nur auf gesetzlicher Grundlage","Bei Verdacht","Immer","Nie"],c:0},
{q:"Wie heißt die Gewaltenteilung (§5)?",a:["Legislative, Exekutive, Judikative","Polizei & Gericht","Militär","Rat & König"],c:0},
{q:"Maximale Festhaltung (§31)?",a:["60 Minuten","120 Minuten","240 Minuten","Unbegrenzt"],c:1},
{q:"Alkoholgrenze (§44)?",a:["1,0‰","0,3‰","0,5‰","0,8‰"],c:2},
{q:"Höchstgeschwindigkeit innerorts (§43)?",a:["100 km/h","80 km/h","50 km/h","130 km/h"],c:1},
{q:"Was ist Betrug (§21)?",a:["Täuschung zur Erlangung eines Vermögensvorteils","Diebstahl","Raub","Unfall"],c:0},
{q:"Was ist Raub (§15)?",a:["Gewaltloser Diebstahl","Einbruch","Diebstahl mit Gewalt","Fahrlässigkeit"],c:2},
{q:"Was ist Mord (§11)?",a:["Fahrlässige Tötung","Heimtückische Tötung","Notwehr","Unfall"],c:1},
{q:"Was ist Amtsmissbrauch (§25)?",a:["Missbrauch staatlicher Position","Bestechung","Verkehrsdelikt","Insolvenz"],c:0},
{q:"Wann darf Zwang angewendet werden (§33)?",a:["Wenn mildere Mittel nicht ausreichen","Immer","Nie","Bei jeder Kontrolle"],c:0},
{q:"Was ist Freiheitsberaubung (§12)?",a:["Unrechtmäßiges Festhalten","Verurteilung","Bußgeld","Lizenzentzug"],c:0},
{q:"Was ist Erpressung (§22)?",a:["Drohung zur Erzwingung von Geld","Diebstahl","Betrug","Verkehrsverstoß"],c:0},
{q:"Welche Strafe kennt §26?",a:["Geldstrafe","Nur Bewährung","Nur Haft","Keine"],c:0},
{q:"Was ist Widerstand (§17)?",a:["Gewalt gegen Amtsträger","Beleidigung","Flucht","Anzeige"],c:0},
{q:"Waffenbesitz erlaubt mit (§35)?",a:["WBK","Personalausweis","Führerschein","Steuernummer"],c:0},
{q:"Wie entsteht ein Vertrag (§46)?",a:["Angebot und Annahme","Zeuge","Polizei","Gerichtsbeschluss"],c:0},
{q:"Wer erhält Grundsicherung (§54)?",a:["Bedürftige","Jeder","Nur Beamte","Niemand"],c:0}

];

function shuffle(array){
for (let i = array.length - 1; i > 0; i--) {
const j = Math.floor(Math.random() * (i + 1));
[array[i], array[j]] = [array[j], array[i]];
}
return array;
}

function loadQuiz(){

let selected = shuffle([...questionPool]).slice(0,TOTAL_QUESTIONS);

currentQuestions = selected;

const quiz=document.getElementById("quiz");
quiz.innerHTML="";

selected.forEach((item,index)=>{

let answers = shuffle([...item.a]);
let correctIndex = answers.indexOf(item.a[item.c]);
item.correctIndex = correctIndex;

quiz.innerHTML+=`
<div class='question'>
<p>${index+1}. ${item.q}</p>
${answers.map((ans,i)=>`
<label>
<input type="radio" name="q${index}" value="${i}"> ${ans}
</label><br>
`).join("")}
</div>`;
});
}

async function submitExam(){

if(submitted) return;
submitted = true;

clearInterval(timerInterval);

let score=0;

currentQuestions.forEach((q,i)=>{
let chosen=document.querySelector(`input[name=q${i}]:checked`);
if(chosen && parseInt(chosen.value)===q.correctIndex) score++;
});

let percent=Math.round((score/TOTAL_QUESTIONS)*100);
let status = percent>=PASS_PERCENTAGE ? "Bestanden" : "Nicht bestanden";

let resultHTML=`<h2>${status} (${percent}%)</h2>`;

document.getElementById("result").classList.remove("hidden");
document.getElementById("result").innerHTML=resultHTML;

await supabaseClient.from("exams").insert([
{
name: document.getElementById("rpname").value,
kanzlei: document.getElementById("kanzlei").value,
score: score,
percent: percent,
status: status
}
]);

if(percent>=PASS_PERCENTAGE){
generateCertificate(percent);
}

}

function generateCertificate(score){
const { jsPDF } = window.jspdf;
const doc = new jsPDF();
doc.setFontSize(22);
doc.text("Bavaria State",70,20);
doc.setFontSize(16);
doc.text("Juristische Staatszulassung",60,35);
doc.text("Name: "+rpname.value,20,60);
doc.text("Kanzlei: "+kanzlei.value,20,75);
doc.text("Ergebnis: "+score+"%",20,90);
doc.save("Bavaria_Staatszertifikat.pdf");
}

timerInterval=setInterval(()=>{
timeLeft--;
let min=Math.floor(timeLeft/60);
let sec=timeLeft%60;
document.getElementById("time").textContent=
`${min}:${sec<10?'0':''}${sec}`;
if(timeLeft<=0) submitExam();
},1000);

function adminLogin(){

const email = document.getElementById("adminEmail").value;
const password = document.getElementById("adminPass").value;

async function adminLogin(){

const email = document.getElementById("adminEmail").value;
const password = document.getElementById("adminPass").value;

const { data, error } = await supabaseClient.auth.signInWithPassword({
email: email,
password: password
});

console.log(data, error);

if(error){
alert(error.message);
return;
}

window.location.href = "admin.html";

}

}

loadQuiz();

</script>

</body>
</html>
